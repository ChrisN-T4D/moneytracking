# Neu Money Tracking — Portainer stack (Git repo build)
#
# Set in Portainer stack "Environment variables" (never commit real values):
#   HOST                          — domain for this app (e.g. your-domain.com)
#   NEXT_PUBLIC_POCKETBASE_URL    — PocketBase URL
#   POCKETBASE_ADMIN_EMAIL        — PocketBase admin email
#   POCKETBASE_ADMIN_PASSWORD     — PocketBase admin password
#   CACHE_BUST                    — optional; set to 2, 3, … to force a full image rebuild on Pull and redeploy (Portainer CE workaround)
#
# Ensure external network name matches your Traefik network (e.g. traefik_proxy).

services:
  app:
    build:
      context: .
      args:
        CACHE_BUST: ${CACHE_BUST:-1}
    image: neu-money-tracking:latest
    container_name: neu-money-tracking
    restart: unless-stopped
    # Port only needed for direct access; Traefik routes by hostname
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_POCKETBASE_URL=${NEXT_PUBLIC_POCKETBASE_URL:-}
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:-}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD:-}
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      # HTTP Routers & Services (HOST from stack env, e.g. your-domain.com)
      - "traefik.http.routers.nmt.entrypoints=websecure"
      - "traefik.http.routers.nmt.rule=Host(`${HOST:-your-domain.com}`)"
      - "traefik.http.routers.nmt.tls.certresolver=le"
      - "traefik.http.routers.nmt.service=nmt"
      - "traefik.http.services.nmt.loadbalancer.server.port=3000"
      # 10GB request/response body limit for this app's router
      - "traefik.http.routers.nmt.middlewares=limit@docker"
      - "traefik.http.middlewares.limit.buffering.maxRequestBodyBytes=10737418240"
      - "traefik.http.middlewares.limit.buffering.memRequestBodyBytes=200000000"
      - "traefik.http.middlewares.limit.buffering.maxResponseBodyBytes=10737418240"
      - "traefik.http.middlewares.limit.buffering.memResponseBodyBytes=200000000"
    networks:
      - nmt_internal
      - traefik_proxy

networks:
  # Do not use name: default — Docker reserves that and returns "operation not permitted"
  nmt_internal:
    name: nmt_internal
  traefik_proxy:
    external: true
